<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¢é˜Ÿä»»åŠ¡æ±  - åä½œç‰ˆ</title>
    
    <!-- 1. Vue 3 -->
    <script src="https://registry.npmmirror.com/vue/3.3.4/files/dist/vue.global.prod.js"></script>
    
    <!-- 2. LeanCloud SDK -->
    <script src="https://registry.npmmirror.com/leancloud-storage/4.15.0/files/dist/av-min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { background: white; border-bottom: 1px solid #e2e8f0; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        /* ç”¨æˆ·å¤´åƒåŒºåŸŸ */
        .user-area { display: flex; align-items: center; gap: 12px; position: relative; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .avatar:hover { border-color: var(--primary); }
        .user-menu { position: absolute; top: 45px; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 140px; overflow: hidden; display: none; flex-direction: column; z-index: 20; }
        .user-menu.show { display: flex; animation: slideDown 0.2s ease; }
        .menu-item { padding: 10px 16px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; text-align: left; background: none; border: none; width: 100%; color: var(--text-main); }
        .menu-item:hover { background: #f1f5f9; color: var(--primary); }
        .menu-item.danger { color: #ef4444; border-top: 1px solid #f1f5f9; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* æŒ‰é’®é€šç”¨ */
        .btn { padding: 10px 16px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.95rem; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #e2e8f0; color: var(--text-main); }
        
        /* ç™»å½•/æ³¨å†Œé¡µ */
        .auth-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 50; }
        .auth-box { width: 90%; max-width: 340px; }
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: 600; color: var(--text-sub); transition: 0.2s; }
        .auth-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); margin-bottom: -2px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; outline: none; transition: 0.2s; }
        .input-field:focus { border-color: var(--primary); }

        /* ä¸»åŒºåŸŸ */
        .main-area { flex: 1; overflow-y: auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* ä»»åŠ¡å¡ç‰‡ */
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        
        .title-area { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
        .card-title { font-size: 1.25rem; font-weight: 700; color: var(--text-main); line-height: 1.4; word-break: break-all; }
        
        .info-badge { width: 20px; height: 20px; min-width: 20px; border-radius: 50%; border: 1.5px solid #94a3b8; color: #94a3b8; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; font-family: serif; font-weight: bold; transition: 0.2s; }
        .info-badge:hover { color: var(--primary); border-color: var(--primary); background: #eff6ff; }

        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 4px; border-radius: 6px; color: #94a3b8; }
        .icon-btn:hover { background: #f1f5f9; color: var(--text-main); }

        .data-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 12px; }
        .data-val { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .text-green { color: #10b981; }

        .card-actions { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; margin-top: auto; }
        .btn-add { background: #eff6ff; color: var(--primary); }
        .btn-cam { background: var(--text-main); color: white; }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .modal { background: white; border-radius: 20px; width: 90%; max-width: 380px; padding: 24px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; max-height: 85vh; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .upload-box { height: 160px; border: 2px dashed #cbd5e1; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f8fafc; overflow: hidden; position: relative; }
        .upload-box img { width: 100%; height: 100%; object-fit: cover; }

        /* === æ–°å¢ï¼šæ»‘åŠ¨åˆ é™¤æ ·å¼ === */
        .log-list { flex: 1; overflow-y: auto; overflow-x: hidden; }
        .log-item-wrapper { position: relative; margin-bottom: 15px; overflow: hidden; }
        
        /* çº¢è‰²åˆ é™¤èƒŒæ™¯å±‚ */
        .log-delete-bg { position: absolute; top: 0; bottom: 0; right: 0; width: 80px; background: var(--danger); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 0 12px 12px 0; z-index: 1; }
        
        /* å†…å®¹å±‚ */
        .log-item-content { position: relative; background: white; z-index: 2; transition: transform 0.2s ease-out; display: flex; gap: 12px; align-items: flex-start; padding-bottom: 10px; border-bottom: 1px solid #f8fafc; width: 100%; }
        /* å·¦æ»‘æ¿€æ´»çŠ¶æ€ */
        .log-item-wrapper.swiped .log-item-content { transform: translateX(-80px); }
    </style>
</head>
<body>

<div id="app">
    <!-- ================= 1. ç™»å½•/æ³¨å†Œé¡µ ================= -->
    <div v-if="!user" class="auth-screen">
        <div class="auth-box">
            <h1 style="color: var(--primary); margin-bottom: 20px; text-align: center;">TaskPool</h1>
            
            <div class="auth-tabs">
                <div @click="authMode='login'" :class="['auth-tab', authMode==='login'?'active':'']">ç™»å½•</div>
                <div @click="authMode='register'" :class="['auth-tab', authMode==='register'?'active':'']">æ³¨å†Œè´¦å·</div>
            </div>

            <div v-if="authMode === 'register'" class="input-group">
                <label class="input-label">æ˜µç§° (å¤§å®¶æ€ä¹ˆç§°å‘¼ä½ )</label>
                <input v-model="authForm.nickname" class="input-field" placeholder="ä¾‹å¦‚: äº§å“é˜¿å¼º">
            </div>

            <div class="input-group">
                <label class="input-label">è´¦å·</label>
                <input v-model="authForm.username" class="input-field" placeholder="è¾“å…¥è´¦å·">
            </div>

            <div class="input-group">
                <label class="input-label">å¯†ç </label>
                <input v-model="authForm.password" type="password" class="input-field" placeholder="è¾“å…¥å¯†ç " @keyup.enter="handleAuth">
            </div>

            <button @click="handleAuth" class="btn btn-primary" style="width: 100%; padding: 12px;">
                {{ authMode === 'login' ? 'ç«‹å³ç™»å½•' : 'æ³¨å†Œå¹¶ç™»å½•' }}
            </button>
            <p v-if="authError" style="color: #ef4444; font-size: 0.85rem; margin-top: 10px; text-align: center;">{{ authError }}</p>
        </div>
    </div>

    <!-- ================= 2. ä¸»ç•Œé¢ ================= -->
    <div v-else style="height: 100%; display: flex; flex-direction: column;">
        <header class="header">
            <div class="brand">
                <span>TaskPool</span>
                <span v-if="loading" style="font-size: 0.8rem; animation: spin 1s linear infinite;">ğŸ”„</span>
            </div>
            
            <div class="user-area">
                <button @click="showAddModal = true" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;">+ æ–°å»º</button>
                
                <!-- å¤´åƒ & ä¸‹æ‹‰èœå• -->
                <div style="position: relative;">
                    <img :src="user.avatar || defaultAvatar" class="avatar" @click="showUserMenu = !showUserMenu" title="ä¸ªäººä¸­å¿ƒ">
                    <div :class="['user-menu', showUserMenu ? 'show' : '']">
                        <button class="menu-item" @click="openProfileEdit">âœï¸ ä¿®æ”¹èµ„æ–™</button>
                        <button class="menu-item danger" @click="logout">ğŸšª é€€å‡ºç™»å½•</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•çš„é®ç½© -->
        <div v-if="showUserMenu" @click="showUserMenu = false" style="position: fixed; inset: 0; z-index: 9;"></div>

        <main class="main-area">
            <div class="grid">
                <div v-for="task in tasks" :key="task.id" class="card">
                    <div class="card-header">
                        <div class="title-area">
                            <div class="info-badge" @click="showTaskInfo(task)">i</div>
                            <span class="card-title">{{ task.title }}</span>
                        </div>

                        <div style="margin-left: 10px; display: flex;">
                            <button @click="openEdit(task)" class="icon-btn" title="è®¾ç½®">âš™ï¸</button>
                            <button @click="viewDetails(task)" class="icon-btn" title="è®°å½•">ğŸ“œ</button>
                        </div>
                    </div>

                    <div class="data-row">
                        <div>
                            <div style="font-size:0.75rem; color:var(--text-sub);">å·²å®Œæˆ</div>
                            <div class="data-val text-green">{{ task.completed }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size:0.75rem; color:var(--text-sub);">ç›®æ ‡</div>
                            <div class="data-val">{{ task.total }}</div>
                        </div>
                    </div>

                    <div class="card-actions">
                        <button @click="incrementTotal(task)" class="btn btn-add">+ åŠ é‡</button>
                        <button @click="openCheckIn(task)" class="btn btn-cam">ğŸ“· æ‰“å¡</button>
                    </div>
                </div>
            </div>
            
            <div v-if="tasks.length === 0 && !loading" style="text-align: center; margin-top: 60px; color: var(--text-sub);">
                <h2>ğŸ‘‹ æ¬¢è¿åŠ å…¥</h2>
                <p style="margin-top: 10px;">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»ºä¸€ä¸ªå§</p>
            </div>
        </main>
    </div>

    <!-- å¼¹çª— 1ï¼šæ–°å»ºä»»åŠ¡ -->
    <div v-if="showAddModal" class="modal-mask">
        <div class="modal">
            <h3>æ–°å»ºå›¢é˜Ÿä»»åŠ¡</h3>
            <div class="input-group">
                <label class="input-label">ä»»åŠ¡åç§°</label>
                <input v-model="newTask.title" class="input-field" placeholder="ä¾‹å¦‚: æ¯æ—¥ä»£ç å®¡æŸ¥">
            </div>
            <div class="input-group">
                <label class="input-label">åˆå§‹ç›®æ ‡æ•°</label>
                <input v-model.number="newTask.total" type="number" class="input-field" placeholder="10">
            </div>
            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button @click="showAddModal = false" class="btn btn-outline" style="flex:1">å–æ¶ˆ</button>
                <button @click="createTask" class="btn btn-primary" style="flex:1">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 2ï¼šä¸ªäººèµ„æ–™ä¿®æ”¹ -->
    <div v-if="showProfileModal" class="modal-mask">
        <div class="modal">
            <h3>ä¿®æ”¹ä¸ªäººèµ„æ–™</h3>
            <div style="margin: 20px 0; text-align: center;">
                <div class="upload-box" style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto;" @click="$refs.avatarInput.click()">
                    <img v-if="profileForm.avatar" :src="profileForm.avatar">
                    <span v-else style="font-size: 2rem;">ğŸ“·</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 8px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                <input type="file" ref="avatarInput" accept="image/*" @change="handleAvatarChange" style="display: none;">
            </div>
            <div class="input-group">
                <label class="input-label">æ˜µç§°</label>
                <input v-model="profileForm.nickname" class="input-field">
            </div>
            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button @click="showProfileModal = false" class="btn btn-outline" style="flex:1">å–æ¶ˆ</button>
                <button @click="saveProfile" class="btn btn-primary" style="flex:1">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 3ï¼šæ‰“å¡ -->
    <div v-if="showCheckInModal" class="modal-mask">
        <div class="modal">
            <h3>æ‰“å¡æäº¤</h3>
            <p style="color: var(--text-sub); margin-bottom: 20px;">{{ currentTask.title }}</p>
            <div class="upload-box" @click="$refs.checkInInput.click()">
                <img v-if="checkInImage" :src="checkInImage">
                <div v-else style="text-align: center; color: #94a3b8;">
                    <div style="font-size: 2rem;">ğŸ“·</div>
                    <span>ç‚¹å‡»æ‹ç…§/ä¸Šä¼ </span>
                </div>
            </div>
            <input type="file" ref="checkInInput" accept="image/*" @change="handleCheckInFile" style="display: none;">
            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button @click="closeCheckIn" class="btn btn-outline" style="flex:1">å–æ¶ˆ</button>
                <button @click="submitCheckIn" :disabled="!checkInImage || uploading" class="btn btn-primary" style="flex:1">
                    {{ uploading ? 'æäº¤ä¸­...' : 'ç¡®è®¤æ‰“å¡' }}
                </button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 4ï¼šè¯¦æƒ… & å†å² (åŒ…å«å·¦æ»‘åˆ é™¤) -->
    <div v-if="showDetailModal" class="modal-mask">
        <div class="modal" style="height: 60vh;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <div>
                    <h3>ğŸ“œ æ‰“å¡è®°å½•</h3>
                    <div style="font-size:0.75rem; color: #94a3b8; font-weight: normal; margin-top:2px;">å·¦æ»‘å¯åˆ é™¤è®°å½•</div>
                </div>
                <button @click="showDetailModal=false" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
            </div>
            
            <div class="log-list">
                <div v-if="!currentTask.logs || currentTask.logs.length===0" style="text-align:center; color:#94a3b8; margin-top:30px;">
                    æš‚æ— è®°å½•
                </div>

                <!-- å¾ªç¯åˆ—è¡¨ï¼Œå¢åŠ æ‰‹åŠ¿å¤„ç† -->
                <div v-for="(log, idx) in currentTask.logs" :key="idx" 
                     :class="['log-item-wrapper', swipedIndex === idx ? 'swiped' : '']">
                    
                    <!-- èƒŒæ™¯åˆ é™¤æŒ‰é’® -->
                    <div class="log-delete-bg" @click="deleteLog(currentTask, idx)">
                        åˆ é™¤
                    </div>

                    <!-- å‰æ™¯å†…å®¹åŒºåŸŸ -->
                    <div class="log-item-content"
                         @touchstart="touchStart($event, idx)"
                         @touchmove="touchMove($event)"
                         @touchend="touchEnd($event)">
                         
                        <!-- æ‰“å¡è€…å¤´åƒ -->
                        <img :src="log.userAvatar || defaultAvatar" style="width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #e2e8f0; flex-shrink:0;">
                        
                        <div style="flex:1; min-width: 0;">
                            <!-- æ‰“å¡è€…åå­— -->
                            <div style="font-weight:700; font-size:0.95rem; color: var(--text-main);">
                                {{ log.userNickname || 'æœªçŸ¥æˆå‘˜' }}
                            </div>
                            <!-- æ—¶é—´ -->
                            <div style="font-size:0.75rem; color:var(--text-sub); margin-top: 2px;">
                                {{ formatTime(log.time) }}
                            </div>
                        </div>
                        
                        <!-- ç¼©ç•¥å›¾ -->
                        <div style="width:60px; height:60px; border-radius:8px; overflow:hidden; background:#f1f5f9; cursor:pointer;" @click.stop="viewImage(log.image)">
                            <img :src="log.image" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¼¹çª— 5ï¼šä¿®æ”¹è®¾ç½® -->
    <div v-if="showEditModal" class="modal-mask">
        <div class="modal">
            <h3>è°ƒæ•´ç›®æ ‡</h3>
            <p style="color:var(--text-sub); margin-bottom:15px;">{{ currentTask.title }}</p>
            <input v-model.number="editTaskData.total" type="number" class="input-field" style="font-size: 1.5rem; font-weight:bold; text-align:center;">
            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button @click="showEditModal = false" class="btn btn-outline" style="flex:1">å–æ¶ˆ</button>
                <button @click="submitEdit" class="btn btn-primary" style="flex:1">ä¿å­˜</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, ref } = Vue;

    const APP_ID = "gJTyMrEMqWR5p5vpxD8YtzUN-MdYXbMMI"; 
    const APP_KEY = "vpD3HoL0aLksDpdudA5oMGDv";
    const SERVER_URL = "https://gjtymrem.api.lncldglobal.com"; 

    if (typeof AV !== 'undefined') {
        AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
    }

    createApp({
        data() {
            return {
                user: null,
                authMode: 'login',
                authForm: { username: '', password: '', nickname: '' },
                authError: '',
                showUserMenu: false,
                defaultAvatar: 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
                showProfileModal: false,
                profileForm: { nickname: '', avatar: '' },
                tasks: [],
                loading: false,
                uploading: false,
                showAddModal: false, showCheckInModal: false, showDetailModal: false, showEditModal: false,
                newTask: { title: '', total: 10 },
                currentTask: {},
                editTaskData: { total: 0 },
                checkInImage: null,
                
                // æ»‘åŠ¨åˆ é™¤ç›¸å…³å˜é‡
                swipedIndex: -1,
                touchStartX: 0,
                touchCurrentX: 0
            }
        },
        mounted() {
            const currentUser = AV.User.current();
            if (currentUser) {
                this.setUser(currentUser);
                this.fetchTasks();
                setInterval(this.fetchTasks, 5000);
            }
        },
        methods: {
            // === æ ¸å¿ƒï¼šé”™è¯¯ç¿»è¯‘ ===
            getErrorMessage(error) {
                // LeanCloud å¸¸è§é”™è¯¯ä»£ç æ˜ å°„
                const codeMap = {
                    202: 'è¯¥ç”¨æˆ·åå·²è¢«å ç”¨ï¼Œè¯·æ¢ä¸€ä¸ª',
                    210: 'è´¦å·æˆ–å¯†ç é”™è¯¯',
                    211: 'æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·',
                    219: 'ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•',
                    217: 'æ— æ•ˆçš„ç”¨æˆ·åï¼Œä¸å…è®¸ç©ºç™½',
                    203: 'ç”µå­é‚®ç®±åœ°å€å·²è¢«å ç”¨',
                    0: 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ (Webå®‰å…¨åŸŸåé…ç½®)'
                };
                if (codeMap[error.code]) return codeMap[error.code];
                if (error.message && error.message.includes('Network')) return 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®æˆ–Webå®‰å…¨åŸŸå';
                return 'å‘ç”Ÿé”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯');
            },
            
            setUser(avUser) {
                this.user = {
                    id: avUser.id,
                    username: avUser.get('username'),
                    nickname: avUser.get('nickname') || avUser.get('username'),
                    avatar: avUser.get('avatar')
                };
            },
            async handleAuth() {
                this.authError = '';
                if (!this.authForm.username || !this.authForm.password) {
                    this.authError = 'è´¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©º'; return;
                }
                try {
                    if (this.authMode === 'login') {
                        const user = await AV.User.logIn(this.authForm.username, this.authForm.password);
                        this.setUser(user);
                        this.fetchTasks();
                        setInterval(this.fetchTasks, 5000);
                    } else {
                        const user = new AV.User();
                        user.setUsername(this.authForm.username);
                        user.setPassword(this.authForm.password);
                        user.set('nickname', this.authForm.nickname || this.authForm.username);
                        await user.signUp();
                        this.setUser(user);
                        this.fetchTasks();
                        setInterval(this.fetchTasks, 5000);
                    }
                } catch (error) { this.authError = this.getErrorMessage(error); }
            },
            async logout() {
                await AV.User.logOut();
                this.user = null;
                this.showUserMenu = false;
                window.location.reload();
            },
            openProfileEdit() {
                this.profileForm.nickname = this.user.nickname;
                this.profileForm.avatar = this.user.avatar;
                this.showUserMenu = false;
                this.showProfileModal = true;
            },
            handleAvatarChange(e) {
                this.compressImage(e.target.files[0], (base64) => { this.profileForm.avatar = base64; });
            },
            async saveProfile() {
                try {
                    const currentUser = AV.User.current();
                    currentUser.set('nickname', this.profileForm.nickname);
                    currentUser.set('avatar', this.profileForm.avatar);
                    await currentUser.save();
                    this.setUser(currentUser);
                    this.showProfileModal = false;
                } catch(e) { alert(this.getErrorMessage(e)); }
            },
            async fetchTasks() {
                try {
                    const query = new AV.Query('Task');
                    query.descending('createdAt');
                    const results = await query.find();
                    
                    this.tasks = results.map(t => ({
                        id: t.id,
                        title: t.get('title'),
                        total: t.get('total'),
                        completed: t.get('completed'),
                        logs: t.get('logs') || [],
                        creator: t.get('createdBy') || 'æœªçŸ¥æˆå‘˜',
                        createdAt: t.createdAt
                    }));
                } catch (error) { console.error("Fetch error:", error); }
            },
            showTaskInfo(task) {
                const date = new Date(task.createdAt).toLocaleString();
                alert(`ğŸ“‹ ä»»åŠ¡ä¿¡æ¯\n\nğŸ‘¤ åˆ›å»ºäºº: ${task.creator}\nğŸ“… åˆ›å»ºäº: ${date}`);
            },
            async createTask() {
                if (!this.newTask.title) return;
                try {
                    const Task = AV.Object.extend('Task');
                    const task = new Task();
                    const acl = new AV.ACL();
                    acl.setPublicReadAccess(true);
                    acl.setPublicWriteAccess(true);
                    task.setACL(acl);

                    task.set('title', this.newTask.title);
                    task.set('total', this.newTask.total || 10);
                    task.set('completed', 0);
                    task.set('logs', []);
                    task.set('createdBy', this.user.nickname);
                    
                    await task.save();
                    this.showAddModal = false;
                    this.newTask = { title: '', total: 10 };
                    this.fetchTasks();
                } catch(e) { alert(this.getErrorMessage(e)); }
            },
            async incrementTotal(task) {
                try {
                    task.total++; 
                    const todo = AV.Object.createWithoutData('Task', task.id);
                    todo.increment('total', 1);
                    await todo.save();
                } catch(e) { 
                    task.total--; // rollback
                    alert(this.getErrorMessage(e)); 
                }
            },
            openCheckIn(task) { this.currentTask = task; this.checkInImage = null; this.showCheckInModal = true; },
            closeCheckIn() { this.showCheckInModal = false; this.checkInImage = null; },
            handleCheckInFile(e) {
                this.compressImage(e.target.files[0], (base64) => { this.checkInImage = base64; });
            },
            async submitCheckIn() {
                if (!this.checkInImage) return;
                this.uploading = true;
                const log = {
                    userId: this.user.id,
                    userNickname: this.user.nickname,
                    userAvatar: this.user.avatar,
                    time: new Date().toISOString(),
                    image: this.checkInImage
                };
                const todo = AV.Object.createWithoutData('Task', this.currentTask.id);
                todo.increment('completed', 1);
                todo.add('logs', log);
                try {
                    await todo.save();
                    this.closeCheckIn();
                    this.fetchTasks();
                } catch (e) { alert('æ‰“å¡å¤±è´¥: ' + this.getErrorMessage(e)); } 
                finally { this.uploading = false; }
            },
            
            // === æ»‘åŠ¨åˆ é™¤é€»è¾‘ ===
            touchStart(e, index) {
                // é‡ç½®å…¶ä»–å·²æ‰“å¼€çš„é¡¹ç›®
                if (this.swipedIndex !== -1 && this.swipedIndex !== index) {
                    this.swipedIndex = -1;
                }
                this.touchStartX = e.touches[0].clientX;
            },
            touchMove(e) {
                this.touchCurrentX = e.touches[0].clientX;
            },
            touchEnd(e, index) {
                // æ»‘åŠ¨è·ç¦»é˜ˆå€¼
                const diff = this.touchStartX - this.touchCurrentX;
                // å¦‚æœå‘å·¦æ»‘è¶…è¿‡ 50px
                if (diff > 50) {
                    this.swipedIndex = index; // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                } else if (diff < -50) {
                    this.swipedIndex = -1; // å‘å³æ»‘ï¼Œå…³é—­åˆ é™¤æŒ‰é’®
                }
                // æ¸…ç†
                this.touchStartX = 0;
                this.touchCurrentX = 0;
            },
            async deleteLog(task, index) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿ')) {
                    this.swipedIndex = -1;
                    return;
                }

                try {
                    // è·å–è¦åˆ é™¤çš„æ—¥å¿—å¯¹è±¡
                    const logToRemove = task.logs[index];
                    
                    const todo = AV.Object.createWithoutData('Task', task.id);
                    
                    // LeanCloud åŸå­æ“ä½œï¼šä»æ•°ç»„ä¸­ç§»é™¤è¯¥å¯¹è±¡
                    todo.remove('logs', logToRemove);
                    // å‡å°‘å®Œæˆæ•°
                    todo.increment('completed', -1);
                    
                    await todo.save();
                    
                    // å‰ç«¯æ‰‹åŠ¨æ›´æ–°ï¼Œé¿å…ç«‹å³åˆ·æ–°çš„å»¶è¿Ÿæ„Ÿ
                    task.logs.splice(index, 1);
                    task.completed--;
                    this.swipedIndex = -1;
                    
                    this.fetchTasks(); // åå°åŒæ­¥
                } catch (e) {
                    alert('åˆ é™¤å¤±è´¥: ' + this.getErrorMessage(e));
                }
            },

            openEdit(task) { this.currentTask = task; this.editTaskData.total = task.total; this.showEditModal = true; },
            async submitEdit() {
                try {
                    const todo = AV.Object.createWithoutData('Task', this.currentTask.id);
                    todo.set('total', this.editTaskData.total);
                    await todo.save();
                    this.showEditModal = false;
                    this.fetchTasks();
                } catch(e) { alert(this.getErrorMessage(e)); }
            },
            viewDetails(task) { 
                this.currentTask = task; 
                this.swipedIndex = -1; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
                this.showDetailModal = true; 
            },
            viewImage(src) { 
                const w = window.open(""); 
                w.document.write(`<img src="${src}" style="max-width:100%; display:block; margin:0 auto;">`); 
            },
            formatTime(iso) { 
                const d = new Date(iso); 
                return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`; 
            },
            compressImage(file, callback) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 600 / img.width;
                        canvas.width = Math.min(img.width, 600);
                        canvas.height = img.height * (scale < 1 ? scale : 1);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        callback(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
                reader.readAsDataURL(file);
            }
        }
    }).mount('#app');

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes spin { 100% { transform: rotate(360deg); } }
    `;
    document.head.appendChild(styleSheet);
</script>
</body>
</html>
